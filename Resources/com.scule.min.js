var Scule={namespaces:{}};!function(){Scule.registerNamespace=function(t,e){if(Scule.hasOwnProperty(t))throw"namespace "+t+" is already registered";Scule[t]=e},Scule.registerComponent=function(t,e,i,n){var s=Scule.require(t);if(!s.hasOwnProperty(e))throw"type "+e+" is not registered inside "+t+" namespace";s[e][i]=n},Scule.require=function(t){if(!Scule.hasOwnProperty(t))throw"namespace "+t+" has not been registered, require failed";return Scule[t]},Scule.registerNamespace("global",{constants:{ID_FIELD:"_id",REF_FIELD:"_ref",OBJECT_WILDCARD:"*"},classes:{},functions:{},system:{},variables:{debug:!1}}),Scule.registerNamespace("datastructures",{constants:Scule.require("global").constants,classes:{},variables:{}}),Scule.registerNamespace("instrumentation",{constants:Scule.require("global").constants,classes:{}}),Scule.registerNamespace("interpreter",{functions:{},classes:{},objects:{},variables:{},symbols:{table:{}},arities:{expression:-1,logical:0,binary:1,selective:2,negative:3,range:4,mutate:5,array:6,geospatial:7,variable:8,operand:9,index:10},constants:Scule.require("global").constants}),Scule.registerNamespace("db",{constants:Scule.require("global").constants,functions:{},classes:{},plugins:{},engines:{},objects:{core:{collections:{}}}}),Scule.registerNamespace("events",{functions:{},classes:{},objects:{}}),Scule.registerNamespace("messaging",{functions:{},classes:{},objects:{}})}(),function(){Scule.global.classes.sha1=function(){this.hexcase=0,this.b64pad="",this.hex_sha1=function(t){return this.rstr2hex(this.rstr_sha1(this.str2rstr_utf8(t)))},this.hash=function(t){return this.hex_sha1(t)},this.b64_sha1=function(t){return this.rstr2b64(this.rstr_sha1(this.str2rstr_utf8(t)))},this.any_sha1=function(t,e){return this.rstr2any(this.rstr_sha1(this.str2rstr_utf8(t)),e)},this.hex_hmac_sha1=function(t,e){return this.rstr2hex(this.rstr_hmac_sha1(this.str2rstr_utf8(t),this.str2rstr_utf8(e)))},this.b64_hmac_sha1=function(t,e){return this.rstr2b64(this.rstr_hmac_sha1(this.str2rstr_utf8(t),this.str2rstr_utf8(e)))},this.any_hmac_sha1=function(t,e,i){return this.rstr2any(this.rstr_hmac_sha1(this.str2rstr_utf8(t),this.str2rstr_utf8(e)),i)},this.sha1_vm_test=function(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==this.hex_sha1("abc").toLowerCase()},this.rstr_sha1=function(t){return this.binb2rstr(this.binb_sha1(this.rstr2binb(t),8*t.length))},this.rstr_hmac_sha1=function(t,e){var i=this.rstr2binb(t);i.length>16&&(i=this.binb_sha1(i,8*t.length));for(var n=new Array(16),s=new Array(16),r=0;16>r;r++)n[r]=909522486^i[r],s[r]=1549556828^i[r];var a=this.binb_sha1(n.concat(this.rstr2binb(e)),512+8*e.length);return this.binb2rstr(this.binb_sha1(s.concat(a),672))},this.rstr2hex=function(t){this.hexcase=0;for(var e,i=this.hexcase?"0123456789ABCDEF":"0123456789abcdef",n="",s=0;s<t.length;s++)e=t.charCodeAt(s),n+=i.charAt(15&e>>>4)+i.charAt(15&e);return n},this.rstr2b64=function(t){this.b64pad="";for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="",n=t.length,s=0;n>s;s+=3)for(var r=t.charCodeAt(s)<<16|(n>s+1?t.charCodeAt(s+1)<<8:0)|(n>s+2?t.charCodeAt(s+2):0),a=0;4>a;a++)i+=8*s+6*a>8*t.length?this.b64pad:e.charAt(63&r>>>6*(3-a));return i},this.rstr2any=function(t,e){var i,n,s,r,a=e.length,u=[],c=new Array(Math.ceil(t.length/2));for(i=0;i<c.length;i++)c[i]=t.charCodeAt(2*i)<<8|t.charCodeAt(2*i+1);for(;c.length>0;){for(r=[],s=0,i=0;i<c.length;i++)s=(s<<16)+c[i],n=Math.floor(s/a),s-=n*a,(r.length>0||n>0)&&(r[r.length]=n);u[u.length]=s,c=r}var o="";for(i=u.length-1;i>=0;i--)o+=e.charAt(u[i]);var l=Math.ceil(8*t.length/(Math.log(e.length)/Math.log(2)));for(i=o.length;l>i;i++)o=e[0]+o;return o},this.str2rstr_utf8=function(t){for(var e,i,n="",s=-1;++s<t.length;)e=t.charCodeAt(s),i=s+1<t.length?t.charCodeAt(s+1):0,e>=55296&&56319>=e&&i>=56320&&57343>=i&&(e=65536+((1023&e)<<10)+(1023&i),s++),127>=e?n+=String.fromCharCode(e):2047>=e?n+=String.fromCharCode(192|31&e>>>6,128|63&e):65535>=e?n+=String.fromCharCode(224|15&e>>>12,128|63&e>>>6,128|63&e):2097151>=e&&(n+=String.fromCharCode(240|7&e>>>18,128|63&e>>>12,128|63&e>>>6,128|63&e));return n},this.str2rstr_utf16le=function(t){for(var e="",i=0;i<t.length;i++)e+=String.fromCharCode(255&t.charCodeAt(i),255&t.charCodeAt(i)>>>8);return e},this.str2rstr_utf16be=function(t){for(var e="",i=0;i<t.length;i++)e+=String.fromCharCode(255&t.charCodeAt(i)>>>8,255&t.charCodeAt(i));return e},this.rstr2binb=function(t){var e=new Array(t.length>>2),i=null;for(i=0;i<e.length;i++)e[i]=0;for(i=0;i<8*t.length;i+=8)e[i>>5]|=(255&t.charCodeAt(i/8))<<24-i%32;return e},this.binb2rstr=function(t){for(var e="",i=0;i<32*t.length;i+=8)e+=String.fromCharCode(255&t[i>>5]>>>24-i%32);return e},this.binb_sha1=function(t,e){t[e>>5]|=128<<24-e%32,t[(e+64>>9<<4)+15]=e;for(var i=new Array(80),n=1732584193,s=-271733879,r=-1732584194,a=271733878,u=-1009589776,c=0;c<t.length;c+=16){for(var o=n,l=s,h=r,f=a,g=u,d=0;80>d;d++){i[d]=16>d?t[c+d]:this.bit_rol(i[d-3]^i[d-8]^i[d-14]^i[d-16],1);var S=this.safe_add(this.safe_add(this.bit_rol(n,5),this.sha1_ft(d,s,r,a)),this.safe_add(this.safe_add(u,i[d]),this.sha1_kt(d)));u=a,a=r,r=this.bit_rol(s,30),s=n,n=S}n=this.safe_add(n,o),s=this.safe_add(s,l),r=this.safe_add(r,h),a=this.safe_add(a,f),u=this.safe_add(u,g)}return new Array(n,s,r,a,u)},this.sha1_ft=function(t,e,i,n){return 20>t?e&i|~e&n:40>t?e^i^n:60>t?e&i|e&n|i&n:e^i^n},this.sha1_kt=function(t){return 20>t?1518500249:40>t?1859775393:60>t?-1894007588:-899497514},this.safe_add=function(t,e){var i=(65535&t)+(65535&e),n=(t>>16)+(e>>16)+(i>>16);return n<<16|65535&i},this.bit_rol=function(t,e){return t<<e|t>>>32-e}},Scule.global.classes.md5=function(){this.md5cycle=function(t,e){var i=t[0],n=t[1],s=t[2],r=t[3];i=this.ff(i,n,s,r,e[0],7,-680876936),r=this.ff(r,i,n,s,e[1],12,-389564586),s=this.ff(s,r,i,n,e[2],17,606105819),n=this.ff(n,s,r,i,e[3],22,-1044525330),i=this.ff(i,n,s,r,e[4],7,-176418897),r=this.ff(r,i,n,s,e[5],12,1200080426),s=this.ff(s,r,i,n,e[6],17,-1473231341),n=this.ff(n,s,r,i,e[7],22,-45705983),i=this.ff(i,n,s,r,e[8],7,1770035416),r=this.ff(r,i,n,s,e[9],12,-1958414417),s=this.ff(s,r,i,n,e[10],17,-42063),n=this.ff(n,s,r,i,e[11],22,-1990404162),i=this.ff(i,n,s,r,e[12],7,1804603682),r=this.ff(r,i,n,s,e[13],12,-40341101),s=this.ff(s,r,i,n,e[14],17,-1502002290),n=this.ff(n,s,r,i,e[15],22,1236535329),i=this.gg(i,n,s,r,e[1],5,-165796510),r=this.gg(r,i,n,s,e[6],9,-1069501632),s=this.gg(s,r,i,n,e[11],14,643717713),n=this.gg(n,s,r,i,e[0],20,-373897302),i=this.gg(i,n,s,r,e[5],5,-701558691),r=this.gg(r,i,n,s,e[10],9,38016083),s=this.gg(s,r,i,n,e[15],14,-660478335),n=this.gg(n,s,r,i,e[4],20,-405537848),i=this.gg(i,n,s,r,e[9],5,568446438),r=this.gg(r,i,n,s,e[14],9,-1019803690),s=this.gg(s,r,i,n,e[3],14,-187363961),n=this.gg(n,s,r,i,e[8],20,1163531501),i=this.gg(i,n,s,r,e[13],5,-1444681467),r=this.gg(r,i,n,s,e[2],9,-51403784),s=this.gg(s,r,i,n,e[7],14,1735328473),n=this.gg(n,s,r,i,e[12],20,-1926607734),i=this.hh(i,n,s,r,e[5],4,-378558),r=this.hh(r,i,n,s,e[8],11,-2022574463),s=this.hh(s,r,i,n,e[11],16,1839030562),n=this.hh(n,s,r,i,e[14],23,-35309556),i=this.hh(i,n,s,r,e[1],4,-1530992060),r=this.hh(r,i,n,s,e[4],11,1272893353),s=this.hh(s,r,i,n,e[7],16,-155497632),n=this.hh(n,s,r,i,e[10],23,-1094730640),i=this.hh(i,n,s,r,e[13],4,681279174),r=this.hh(r,i,n,s,e[0],11,-358537222),s=this.hh(s,r,i,n,e[3],16,-722521979),n=this.hh(n,s,r,i,e[6],23,76029189),i=this.hh(i,n,s,r,e[9],4,-640364487),r=this.hh(r,i,n,s,e[12],11,-421815835),s=this.hh(s,r,i,n,e[15],16,530742520),n=this.hh(n,s,r,i,e[2],23,-995338651),i=this.ii(i,n,s,r,e[0],6,-198630844),r=this.ii(r,i,n,s,e[7],10,1126891415),s=this.ii(s,r,i,n,e[14],15,-1416354905),n=this.ii(n,s,r,i,e[5],21,-57434055),i=this.ii(i,n,s,r,e[12],6,1700485571),r=this.ii(r,i,n,s,e[3],10,-1894986606),s=this.ii(s,r,i,n,e[10],15,-1051523),n=this.ii(n,s,r,i,e[1],21,-2054922799),i=this.ii(i,n,s,r,e[8],6,1873313359),r=this.ii(r,i,n,s,e[15],10,-30611744),s=this.ii(s,r,i,n,e[6],15,-1560198380),n=this.ii(n,s,r,i,e[13],21,1309151649),i=this.ii(i,n,s,r,e[4],6,-145523070),r=this.ii(r,i,n,s,e[11],10,-1120210379),s=this.ii(s,r,i,n,e[2],15,718787259),n=this.ii(n,s,r,i,e[9],21,-343485551),t[0]=this.add32(i,t[0]),t[1]=this.add32(n,t[1]),t[2]=this.add32(s,t[2]),t[3]=this.add32(r,t[3])},this.cmn=function(t,e,i,n,s,r){return e=this.add32(this.add32(e,t),this.add32(n,r)),this.add32(e<<s|e>>>32-s,i)},this.ff=function(t,e,i,n,s,r,a){return this.cmn(e&i|~e&n,t,e,s,r,a)},this.gg=function(t,e,i,n,s,r,a){return this.cmn(e&n|i&~n,t,e,s,r,a)},this.hh=function(t,e,i,n,s,r,a){return this.cmn(e^i^n,t,e,s,r,a)},this.ii=function(t,e,i,n,s,r,a){return this.cmn(i^(e|~n),t,e,s,r,a)},this.md51=function(t){/[\x80-\xFF]/.test(t)&&(t=unescape(encodeURI(t)));var e,i=t.length,n=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=t.length;e+=64)this.md5cycle(n,this.md5blk(t.substring(e-64,e)));t=t.substring(e-64);var s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<t.length;e++)s[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(s[e>>2]|=128<<(e%4<<3),e>55)for(this.md5cycle(n,s),e=0;16>e;e++)s[e]=0;return s[14]=8*i,this.md5cycle(n,s),n},this.md5blk=function(t){var e,i=[];for(e=0;64>e;e+=4)i[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return i},this.hex_chr="0123456789abcdef".split(""),this.rhex=function(t){for(var e="",i=0;4>i;i++)e+=this.hex_chr[15&t>>8*i+4]+this.hex_chr[15&t>>8*i];return e},this.hex=function(t){for(var e=0;e<t.length;e++)t[e]=this.rhex(t[e]);return t.join("")},this.hash=function(t){return this.hex(this.md51(t))},this.add32=function(t,e){return 4294967295&t+e}},Scule.global.system.installHashFunctions=function(){Scule.md5=new Scule.global.classes.md5,Scule.sha1=new Scule.global.classes.sha1}}(),function(){Scule.global.functions.hasOwnProperty=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},Scule.global.functions.getObjectId=function(t,e){return void 0===e&&(e=!1),e?t[Scule.global.constants.ID_FIELD].toString():t[Scule.global.constants.ID_FIELD]},Scule.global.functions.cloneObject=function(t){var e={};Scule.global.functions.isArray(t)&&(e=[]);for(var i in t)e[i]="object"==typeof t[i]?t[i]instanceof RegExp?new RegExp(t[i].toString()):Scule.global.functions.cloneObject(t[i]):t[i];return e},Scule.global.functions.traverseObject=function(t,e){var i=0,n=null,s=function(t){for(var e in t)if(Scule.global.functions.hasOwnProperty(t,e)){if(t[e]===!0){n=e;break}i++,s(t[e])}};s(t);var r=0,a=function(t,e){if(r===i)return e;for(var n in t)if(Scule.global.functions.hasOwnProperty(t,n))return Scule.global.functions.hasOwnProperty(e,n)?t[n]===!0?e:(r++,a(t[n],e[n])):null};return[n,a(t,e)]},Scule.global.functions.sortObjectKeys=function(t){var e={},i=[];for(var n in t)Scule.global.functions.hasOwnProperty(t,n)&&i.push(n);return i.sort(function(t,e){var i=!1;t.match(/^\$/)&&(t=t.substr(1),i=!0);var n=!1;return e.match(/^\$/)&&(e=e.substr(1),n=!0),i&&!n?1:n&&!i?-1:e>t?-1:1}),i.forEach(function(i){e[i]=t[i]}),e},Scule.global.functions.objectKeys=function(t){var e=[];for(var i in t)Scule.global.functions.hasOwnProperty(t,i)&&e.push(i);return e},Scule.global.functions.sizeOf=function(t){if(t instanceof Array||"string"==typeof t)return t.length;var e,i=0;for(e in t)Scule.global.functions.hasOwnProperty(t,e)&&i++;return i},Scule.global.functions.shuffle=function(t){var e,i,n=t.length;if(n)for(;--n;)i=Math.floor(Math.random()*(n+1)),e=t[i],t[i]=t[n],t[n]=e},Scule.global.functions.contains=function(t,e){return Scule.global.functions.hasOwnProperty(t,e)},Scule.global.functions.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},Scule.global.functions.isInteger=function(t){return parseInt(t,10)==t},Scule.global.functions.isDouble=function(t){return parseFloat(t)==t},Scule.global.functions.isScalar=function(t){return null!==t&&!(t instanceof Object)},Scule.global.functions.randomFromTo=function(t,e){return Math.floor(Math.random()*(e-t+1)+t)},Scule.global.functions.compare=function(t,e){return t===e?0:t>e?1:-1},Scule.global.functions.sort=function(t,e,i){switch(t){case-1:e.sort(function(t,e){return e[i]-t[i]});break;case 0:Scule.global.functions.shuffle(e);break;case 1:e.sort(function(t,e){return t[i]-e[i]});break;case 2:e.sort(function(t,e){return e[i]>t[i]?-1:e[i]<t[i]?1:0});break;case 3:e.reverse()}},Scule.global.functions.trim=function(t){return String.prototype.trim?t.trim():t.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},Scule.global.functions.getMACAddress=function(){return Scule.global.variables.hasOwnProperty("SimulatedMacAddress")||(Scule.global.variables.SimulatedMacAddress=(new Date).getTime().toString().substring(9,11)+""+Scule.global.functions.randomFromTo(100,999)),Scule.global.variables.SimulatedMacAddress},Scule.global.functions.parseAttributes=function(t){if(!Scule.global.functions.isArray(t))return Scule.global.functions.parseAttributes(t.split(","));var e=function(t,i,n){var s=Scule.global.functions.trim(i[n]);if(n===i.length-1)t[s]=!0;else{var r={};t[s]=r,e(r,i,n+1)}},i={};return t.forEach(function(t){e(i,t.split("."),0)}),i},Scule.global.functions.traverse=function(t,e){var i=function(t,e){if(void 0===e)return void 0;if(1===t.length)return e[t.pop()];var n=t.shift();return i(t,e[n])};return i(t.split("."),e)}}(),function(){Scule.datastructures.variables.fnv_hash=function(t,e){for(var i=2166136261,n=16777619,s=t.length,r=0;s>r;r++)i=(i^t.charCodeAt(r))*n;return i+=i<<13,i^=i>>7,i+=i<<3,i^=i>>17,i+=i<<5,0>i&&(i=-1*i),i%e},Scule.datastructures.variables.djb2_hash=function(t,e){var i=5381,n=t.length,s=0;for(s=0;n>s;s++)i=(i<<5)+i+t.charCodeAt(s);return 0>i&&(i=-1*i),i%e},Scule.datastructures.classes.LinkedList=function(){this.head=null,this.tail=null,this.length=0,this.getHead=function(){return this.head},this.getTail=function(){return this.tail},this.getLength=function(){return this.length},this.isEmpty=function(){return 0===this.length},this.clear=function(){this.head=null,this.tail=null,this.length=0},this.get=function(t){if(0>t||t>this.length)return null;if(0===t)return this.head;for(var e=this.head,i=0;e&&t!==i;)i++,e=e.next;return e},this.add=function(t){var e=new Scule.datastructures.classes.LinkedListNode(null,t);if(null===this.head)this.head=e;else if(null===this.tail)this.head.next=e,this.tail=e;else{var i=this.tail;i.next=e,this.tail=i.next}return this.length++,e},this.search=function(t,e,i){i||(i=Scule.global.functions.compare);for(var n=this.head;n;){if(e){if(0===i(n.element[e],t))break}else if(0===i(n.element,t))break;n=n.next}return n},this.contains=function(t,e){if(null===t)return!1;e||(e=Scule.global.functions.compare);for(var i=this.head;i&&0!==e(i.element,t);)i=i.next;return null!==i},this.split=function(t){var e;if(void 0===t){if(t=Math.floor(this.length/2),e=this.middle(),!e)return null}else{if(1>t||t>this.length)return null;e=this.get(t-1)}var i=new Scule.datastructures.classes.LinkedList;return i.head=e.next,e.next=null,i.tail=this.tail,this.tail=e,i.length=t,this.length=this.length-t,i},this.middle=function(){if(!this.head)return null;for(var t=this.head,e=this.head;e.next&&e.next.next;)t=t.next,e=e.next.next;return t},this.remove=function(t){if(0>t||t>this.length)return null;var e;if(1===this.length)e=this.head,this.clear();else{var i=this.get(t-1);i.next==this.tail?(e=this.tail,this.tail=i):(e=i.next,i.next=i.next.next),this.length--}return e},this.reverse=function(){for(var t=null,e=this.head,i=null;e;)i=e.next,e.next=t,t=e,e=i;i=this.head,this.head=this.tail,this.tail=i},this.toArray=function(){for(var t=[],e=this.head;e;)t.push(e.element),e=e.next;return t},this.forEach=function(t){for(var e=this.head;e;)t(e),e=e.next;return!0},this.sort=function(t,e){if(this.length<2)return this;t||(t=Scule.global.functions.compare);var i=function(t){if(!t)return t;for(var e=t,i=t;i.next&&i.next.next;)e=e.next,i=i.next.next;return e},n=function(i,n){for(var s,r,a={next:null},u=a;i&&n;)e?(s=n.element[e],r=i.element[e]):(s=n.element,r=i.element),t(s,r)>-1?(u.next=i,i=i.next):(u.next=n,n=n.next),u=u.next;return u.next=i?i:n,a.next},s=function(t){if(!t||!t.next)return t;var e=i(t),r=e.next;return e.next=null,n(s(t),s(r))};this.head=s(this.head)}},Scule.datastructures.classes.DoublyLinkedList=function(){this.head=null,this.tail=null,this.length=0,this.getHead=function(){return this.head},this.getTail=function(){return this.tail},this.isEmpty=function(){return 0===this.length},this.getLength=function(){return this.length},this.search=function(t,e,i){i||(i=Scule.global.functions.compare);for(var n=this.head;n;){if(e){if(0===i(n.element[e],t))break}else if(0===i(n.element,t))break;n=n.next}return n},this.contains=function(t,e){if(null===t)return!1;e||(e=Scule.global.functions.compare);for(var i=this.head;i&&0!==e(i.element,t);)i=i.next;return null!==i},this.get=function(t){if(0>t||t>this.length)return null;if(0===t)return this.head;for(var e=this.head,i=0;e&&t!==i;)i++,e=e.next;return e},this.add=function(t){var e=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,t);if(this.isEmpty())this.head=e;else if(this.tail){var i=this.tail;i.next=e,e.prev=i,this.tail=e}else this.tail=e,this.tail.prev=this.head,this.head.next=e;return this.length++,e},this.remove=function(t){if(0>t||t>this.length)return null;var e;if(1===this.length)e=this.head,this.clear();else{var i=this.get(t-1);i.next==this.tail?(e=this.tail,this.tail=i,this.tail.prev=e.prev,this.tail.next=null):(e=i.next,i.next=i.next.next,i.next&&(i.next.prev=i)),this.length--}return e&&e.detach(),e},this.trim=function(){return this.isEmpty()?null:this.remove(this.length-1)},this.split=function(t){var e;if(void 0===t){if(t=Math.floor(this.length/2),e=this.middle(),!e)return null}else{if(1>t||t>this.length)return null;e=this.get(t-1)}var i=new Scule.datastructures.classes.DoublyLinkedList;return i.head=e.next,e.next=null,e.prev=null,i.tail=this.tail,this.tail=e,i.length=t,this.length=this.length-t,i},this.middle=function(){if(!this.head)return null;for(var t=this.head,e=this.head;e.next&&e.next.next;)t=t.next,e=e.next.next;return t},this.sort=function(t,e){if(this.length<2)return this;t||(t=Scule.global.functions.compare);var i=function(t){if(!t)return t;for(var e=t,i=t;i.next&&i.next.next;)e=e.next,i=i.next.next;return e},n=function(i,n){for(var s,r,a={next:null},u=a;i&&n;)e?(s=n.element[e],r=i.element[e]):(s=n.element,r=i.element),t(s,r)>-1?(u.next=i,u.prev=n,i=i.next):(u.next=n,u.prev=i,n=n.next),u=u.next;return u.next=i?i:n,a.next},s=function(t){if(!t||!t.next)return t;var e=i(t),r=e.next;return e.next=null,r.prev=null,n(s(t),s(r))};this.head=s(this.head)},this.reverse=function(){for(var t=this.head,e=null;t;)e=t.next,t.next=t.prev,t.prev=e,t=e;e=this.head,this.head=this.tail,this.tail=e},this.prepend=function(t){var e=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,t);if(this.isEmpty())this.head=e;else{var i=this.head;this.head=e,i.prev=this.head,this.head.next=i,this.tail||(this.tail=i)}return this.length++,e},this.clear=function(){this.head=null,this.tail=null,this.length=0},this.toArray=function(){for(var t=[],e=this.head;e;)t.push(e.element),e=e.next;return t},this.forEach=function(t){for(var e=this.head;e;)t(e),e=e.next;return!0}},Scule.datastructures.classes.CachingLinkedList=function(t,e,i){if(!e)throw"A valid cache key is required to use a CachingLinkedList";t||(t=100),this.cacheKey=e,this.threshold=t,this.cache=new Scule.datastructures.classes.LRUCache(t),i||(i=new Scule.datastructures.classes.LinkedList),this.list=i,this.clear=function(){this.cache.clear(),this.list.clear()},this.remove=function(t){var e=this.list.remove(t);return e&&this.cache.remove(e.element[this.cacheKey]),e},this.middle=function(){return this.list.middle()},this.split=function(){return this.cache.clear(),this.list.split()},this.add=function(t){var e=this.list.add(t);return this.cache.put(e.element[this.cacheKey],e),e},this.search=function(t){if(this.cache.contains(t))return this.cache.get(t);var e=this.list.search(t,this.cacheKey);return e&&this.cache.put(e.element[this.cacheKey],e),e},this.getLength=function(){return this.list.getLength()},this.getTail=function(){return this.list.getTail()},this.getHead=function(){return this.list.getHead()},this.isEmpty=function(){return this.list.isEmpty()},this.get=function(t){return this.list.get(t)},this.contains=function(t){return this.list.contains(t)},this.reverse=function(){this.list.reverse()},this.sort=function(t){this.list.sort(t,this.cacheKey)},this.toArray=function(){return this.list.toArray()},this.forEach=function(t){return this.list.forEach(t)}},Scule.datastructures.classes.LinkedListNode=function(t,e){this.next=t,this.element=e,this.getNext=function(){return this.next},this.setNext=function(t){this.next=t},this.getElement=function(){return this.element},this.setElement=function(t){this.element=t}},Scule.datastructures.classes.DoublyLinkedListNode=function(t,e,i){Scule.datastructures.classes.LinkedListNode.call(this,e,i),this.prev=t,this.getPrev=function(){return this.prev},this.setPrev=function(t){this.prev=t},this.detach=function(){this.prev=null,this.next=null}},Scule.datastructures.classes.LRUCache=function(t){this.threshold=t,this.cache=new Scule.datastructures.classes.HashTable,this.queue=new Scule.datastructures.classes.DoublyLinkedList,this.contains=function(t){return this.cache.contains(t)},this.remove=function(t){if(!this.cache.contains(t))return null;var e=this.cache.get(t);this.cache.remove(t);var i=e.node.prev,n=e.node.next;return i&&(i.next=n),n&&(n.prev=i),e.node.detach(),this.queue.length--,!0},this.get=function(t){if(!this.cache.contains(t))return null;var e=this.cache.get(t);return e.requeue(this.queue),e.value},this.put=function(t,e){var i;if(this.cache.contains(t)?(i=this.cache.get(t),i.value=e,i.node.element={key:t,value:e},i.requeue(this.queue)):(i=new Scule.datastructures.classes.LRUCacheEntry(t,e,this.queue.prepend({key:t,value:e})),this.cache.put(t,i)),this.queue.length>this.threshold){var n=this.queue.trim();if(!this.cache.remove(n.getElement().key))throw"LRU cache is corrupt";n=null}return!0},this.getLength=function(){return this.cache.getLength()},this.clear=function(){this.cache.clear(),this.queue.clear()}},Scule.datastructures.classes.LRUCacheEntry=function(t,e,i){this.key=t,this.value=e,this.node=i,this.getKey=function(){return this.key},this.getValue=function(){return this.value},this.getNode=function(){return this.node},this.requeue=function(t){if(this.node.prev){var e=this.node.prev,i=this.node.next;e.next=i,i&&(i.prev=e),this.node.detach(),t.length--,this.node=t.prepend({key:this.key,value:this.value})}}},Scule.datastructures.classes.LIFOStack=function(){Scule.datastructures.classes.LinkedList.call(this),this.push=function(t){var e=this.head;this.head=new Scule.datastructures.classes.LinkedListNode(e,t),this.length++},this.pop=function(){if(this.isEmpty())return null;var t=this.head;return this.head=t.next,this.length--,t.next=null,t.getElement()},this.peek=function(){return this.isEmpty()?null:this.head.getElement()}},Scule.datastructures.classes.FIFOStack=function(){Scule.datastructures.classes.LIFOStack.call(this),this.push=this.add,this.pop=function(){if(this.isEmpty())return null;var t=this.head;return this.head=t.next,this.length--,t.getElement()}},Scule.datastructures.classes.Queue=function(){Scule.datastructures.classes.FIFOStack.call(this),this.enqueue=this.push,this.dequeue=this.pop},Scule.datastructures.classes.HashMap=function(t){this.size=t,this.buckets=0,this.length=0,this.table=[],this.hash=Scule.datastructures.variables.djb2_hash,this.retable=function(){var t=this.length/this.size;if(!(this.length>=this.buckets&&.7>t)){var e=this.toArray();this.clear(),this.size=2*this.size;for(var i=0;i<e.length;i++)this.put(e[i][0],e[i][1])}},this.bucket=function(t){return this.table[t]||(this.buckets++,this.table[t]=new Scule.datastructures.classes.BinarySearchTree),this.table[t]},this.put=function(t,e){var i=this.hash(t,this.size),n=this.bucket(i),s=n.insert(t,e);return s&&(this.length++,0===n.getLength()%10&&n.balance()),this.retable(),s},this.contains=function(t){var e=this.hash(t,this.size),i=this.bucket(e);return null!==i.search(t)},this.get=function(t){var e=this.hash(t,this.size),i=this.bucket(e),n=i.search(t);return null===n?null:n.getData()},this.search=function(t){return this.get(t)},this.remove=function(t){var e=this.hash(t,this.size),i=this.bucket(e);return i.remove(t)?(this.length--,this.retable(),!0):!1},this.clear=function(){this.table=[],this.length=0,this.buckets=0},this.getLength=function(){return this.length},this.getKeys=function(){var t=[],e=function(i){null!==i&&(t.push(i.getKey()),e(i.getLeft()),e(i.getRight()))};return this.table.forEach(function(t){t&&e(t.getRoot())}),t},this.getValues=function(){var t=[],e=function(i){null!==i&&(t.push(i.getData()),e(i.getLeft()),e(i.getRight()))};return this.table.forEach(function(t){t&&e(t.getRoot())}),t},this.toArray=function(){var t=[];return this.table.forEach(function(e){e&&(t=t.concat(e.toArray()))}),t}},Scule.datastructures.classes.HashTable=function(){this.table={},this.length=0,this.put=function(t,e){this.contains(t)||this.length++,this.table[t]=e},this.get=function(t){return this.contains(t)?this.table[t]:null},this.search=function(t){return this.get(t)},this.remove=function(t){if(this.contains(t)){var e=this.table[t];return delete this.table[t],this.length--,e}return!1},this.contains=function(t){return Scule.global.functions.hasOwnProperty(this.table,t)},this.clear=function(){this.table={},this.length=0},this.getLength=function(){return this.length},this.getKeys=function(){var t=[];for(var e in this.table)this.contains(e)&&t.push(e);return t},this.getValues=function(){var t=[];for(var e in this.table)this.contains(e)&&t.push(this.table[e]);return t},this.toArray=function(){var t=[];for(var e in this.table)this.contains(e)&&(t[e]=this.table[e]);return t}},Scule.datastructures.classes.BinarySearchTreeNode=function(t,e){this.parent=null,this.left=null,this.right=null,this.key=t,this.data=e,this.setParent=function(t){this.parent=t},this.getParent=function(){return this.parent},this.setLeft=function(t){t&&(this.left=t,this.left.setParent(this))},this.getLeft=function(){return this.left},this.setRight=function(t){t&&(this.right=t,this.right.setParent(this))},this.getRight=function(){return this.right},this.getKey=function(){return this.key},this.setData=function(t){this.data=t},this.getData=function(){return this.data},this.clear=function(){this.data=null},this.remove=function(t){return t?t==this.right?(this.setRight(t.getRight()),this.getRight().setLeft(t.getLeft()),t.parent=null,t.left=null,t.right=null,!0):t==this.left?(this.setLeft(t.getRight()),this.getLeft().setLeft(t.getLeft()),t.parent=null,t.left=null,t.right=null,!0):!1:!1}},Scule.datastructures.classes.AtomicCounter=function(t){if(void 0===t&&(t=0),!Scule.global.functions.isInteger(t))throw"Unable to initialize counter with non-integer value";this.count=t,this.increment=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to increment counter with non-integer value";return this.count+=t,this.count},this.decrement=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to decrement counter with non-integer value";return this.count-=t,this.count},this.getCount=function(){return this.count}},Scule.datastructures.classes.BinarySearchTree=function(){this.root=null,this.length=0,this.insert=function(t,e){var i=this,n=new Scule.datastructures.classes.BinarySearchTreeNode(t,e);if(null===this.root)return this.length++,this.root=n,!0;var s=function(t,e){return t.getKey()==e.getKey()?(e.setData(t.getData()),!1):(t.getKey()<=e.getKey()?e.getLeft()?s(t,e.getLeft()):(i.length++,e.setLeft(t)):e.getRight()?s(t,e.getRight()):(i.length++,e.setRight(t)),!0)};return s(n,this.root)},this.search=function(t){var e=function(t,i){return i?i.getKey()==t?i:i.getKey()>t?e(t,i.getLeft()):e(t,i.getRight()):null};return e(t,this.root)},this.remove=function(t){var e=this.search(t);if(!e)return!1;if(!e.getParent())return e.getRight()?(this.root=e.getRight(),this.root.setLeft(e.getLeft())):e.getLeft()?(this.root=e.getRight(),this.root.setLeft(e.getLeft())):this.root=null,this.length--,!0;var i=e.getParent().remove(e);return i&&this.length--,i},this.balance=function(){var t=this,e=this.toArray(),i=function(e){var n=e,s=e.splice(Math.ceil(e.length/2),e.length),r=n.pop();t.insert(r[0],r[1]),n.length>0&&i(n),s.length>0&&i(s)};this.length=0,this.root=null,i(e)},this.getLength=function(){return this.length},this.toArray=function(){var t=function(e){return e?t(e.getLeft()).concat([[e.getKey(),e.getData()]]).concat(t(e.getRight())):[]};return t(this.root)},this.getRoot=function(){return this.root}},Scule.datastructures.classes.BitSet=function(t){if(void 0===t||!Scule.global.functions.isInteger(t)||0>=t)throw"Unable to initialize bitset with non-integer capacity";this.capacity=t,this.words=null,this.zeroFill=function(){this.words=[];for(var t=Math.ceil(this.capacity/32),e=0;t>=e;e++)this.words[e]=0},this.indexToAddress=function(t){if(0>t||t>=this.capacity)throw"Index out of bounds";if(32>t)return{addr:0,offs:t};var e=Math.floor(t/32),i=t%32;return{addr:e,offs:i}},this.get=function(t){var e=this.indexToAddress(t);return 0!=(this.words[e.addr]&1<<e.offs)},this.set=function(t){var e=this.indexToAddress(t);this.words[e.addr]|=1<<e.offs},this.clear=function(t){var e=this.indexToAddress(t);this.words[e.addr]&=~(1<<e.offs)},this.getLength=function(){return this.capacity},this.toString=function(){for(var t="",e=0;e<this.capacity;e++)t+=this.get(e)?1:0;return t},this.zeroFill()},Scule.datastructures.classes.BloomFilter=function(t,e){if(void 0===t||!Scule.global.functions.isInteger(t)||0>=t)throw"Unable to initialize bloom filter with non-integer m";(void 0===e||!Scule.global.functions.isInteger(e)||0>=e)&&(e=Math.floor(t/Math.ceil(t/3))),Scule.datastructures.classes.BitSet.call(this,t),this.k=e,this.f=[];for(var i=0;i<this.k;i++)this.f.push([Scule.global.functions.randomFromTo(0,999999),Scule.global.functions.randomFromTo(0,999999)]);this.hash=function(t,e,i){return Scule.datastructures.variables.fnv_hash(this.f[t][0]+e+this.f[t][1],i)},this.add=function(t){for(var e=0;e<this.k;e++)this.set(this.hash(e,t,this.capacity))},this.query=function(t){for(var e=0;e<this.k;e++)if(!this.get(this.hash(e,t,this.capacity)))return!1;return!0}},Scule.datastructures.classes.AtomicCounter=function(t){if(void 0===t&&(t=0),!Scule.global.functions.isInteger(t))throw"Unable to initialize counter with non-integer value";this.count=t,this.increment=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to increment counter with non-integer value";return this.count+=t,this.count},this.decrement=function(t){if(void 0===t&&(t=1),!Scule.global.functions.isInteger(t))throw"Unable to decrement counter with non-integer value";return this.count-=t,this.count},this.getCount=function(){return this.count}},Scule.getLinkedList=function(){return new Scule.datastructures.classes.LinkedList},Scule.getCachingLinkedList=function(t,e){return new Scule.datastructures.classes.CachingLinkedList(t,e)},Scule.getDoublyLinkedList=function(){return new Scule.datastructures.classes.DoublyLinkedList},Scule.getHashTable=function(){return new Scule.datastructures.classes.HashTable},Scule.getPrimaryKeyIndex=function(){return new Scule.db.classes.PrimaryKeyIndex},Scule.getHashMap=function(t){return new Scule.datastructures.classes.HashMap(t)},Scule.getLIFOStack=function(){return new Scule.datastructures.classes.LIFOStack},Scule.getFIFOStack=function(){return new Scule.datastructures.classes.FIFOStack},Scule.getQueue=function(){return new Scule.datastructures.classes.Queue},Scule.getLRUCache=function(t){return new Scule.datastructures.classes.LRUCache(t)},Scule.getBinarySearchTreeNode=function(t,e){return new Scule.datastructures.classes.BinarySearchTreeNode(t,e)},Scule.getBinarySearchTree=function(){return new Scule.datastructures.classes.BinarySearchTree
},Scule.getAtomicCounter=function(t){return new Scule.datastructures.classes.AtomicCounter(t)},Scule.getBitSet=function(t){return new Scule.datastructures.classes.BitSet(t)},Scule.getBloomFilter=function(t){return new Scule.datastructures.classes.BloomFilter(t)}}(),function(){Scule.instrumentation.classes.Timer=function(){this.intervalCounter=0,this.intervalArray=[],this.intervals=Scule.getLIFOStack(),this.resetTimer=function(){this.intervalCounter=0,this.intervalArray=[],this.intervals.clear()},this.startInterval=function(t){this.intervalCounter++,void 0===t&&(t=this.intervalCounter),this.intervals.push(new Scule.instrumentation.classes.TimerInterval(t)),this.intervalArray.push(this.intervals.peek())},this.stopInterval=function(){return this.intervals.isEmpty()?!1:(this.intervals.peek().stop(),this.intervals.pop())},this.stopAllIntervals=function(){for(;!this.intervals.isEmpty();)this.intervals.pop().stop()},this.logToConsole=function(){this.intervalArray.forEach(function(t){t.logToConsole()})}},Scule.instrumentation.classes.TimerInterval=function(t){this.startTimestamp=(new Date).getTime(),this.endTimestamp=null,this.tag=t,this.stopped=function(){return null!==this.endTimestamp},this.stop=function(){this.endTimestamp=(new Date).getTime()},this.getDifference=function(){return null===this.endTimestamp?!1:this.endTimestamp-this.startTimestamp},this.logToConsole=function(){var t=this.getDifference();t===!1&&console.log("interval "+this.tag+" is still in progress"),console.log("interval "+this.tag+" lasted "+t+"ms")}},Scule.getTimer=function(){return new Scule.instrumentation.classes.Timer}}(),function(){Scule.interpreter.symbols.table={$and:Scule.interpreter.arities.selective,$or:Scule.interpreter.arities.selective,$nor:Scule.interpreter.arities.negative,$not:Scule.interpreter.arities.negative,$lt:Scule.interpreter.arities.range,$lte:Scule.interpreter.arities.range,$gt:Scule.interpreter.arities.range,$gte:Scule.interpreter.arities.range,$all:Scule.interpreter.arities.array,$in:Scule.interpreter.arities.array,$nin:Scule.interpreter.arities.array,$elemMatch:Scule.interpreter.arities.array,$eq:Scule.interpreter.arities.binary,$ne:Scule.interpreter.arities.binary,$size:Scule.interpreter.arities.binary,$exists:Scule.interpreter.arities.binary,$within:Scule.interpreter.arities.geospatial,$near:Scule.interpreter.arities.geospatial,$set:Scule.interpreter.arities.mutate,$inc:Scule.interpreter.arities.mutate,$unset:Scule.interpreter.arities.mutate,$pull:Scule.interpreter.arities.mutate,$pullAll:Scule.interpreter.arities.mutate,$pop:Scule.interpreter.arities.mutate,$push:Scule.interpreter.arities.mutate,$pushAll:Scule.interpreter.arities.mutate,$rename:Scule.interpreter.arities.mutate},Scule.interpreter.classes.QueryNormalizer=function(){this.normalize=function(t){var e=function(t){for(var i in t)if(Scule.global.functions.isScalar(t[i])||t[i]instanceof RegExp||t[i]instanceof Scule.db.classes.ObjectId){var n=t[i];n instanceof Scule.db.classes.ObjectId&&(n=t[i].toString()),delete t[i],t[i]={$eq:n}}else"$or"===i||"$elemMatch"===i?e(t[i]):t[i]=Scule.global.functions.sortObjectKeys(t[i]);return Scule.global.functions.sortObjectKeys(t)};return e(t)}},Scule.interpreter.classes.DateComparator=function(){this.isDate=function(t){return t instanceof Date||t instanceof Scule.db.classes.ObjectDate},this.normalizeDate=function(t){if(!this.isDate(t))throw new Error("unable to compare non-date object");return t instanceof Scule.db.classes.ObjectDate?t.toDate().getTime():t instanceof Date?t.getTime():t},this.$eq=function(t,e){return this.normalizeDate(t)==this.normalizeDate(e)},this.$gt=function(t,e){return this.normalizeDate(t)>this.normalizeDate(e)},this.$gte=function(t,e){return this.normalizeDate(t)>=this.normalizeDate(e)},this.$lt=function(t,e){return this.normalizeDate(t)<this.normalizeDate(e)},this.$lte=function(t,e){return this.normalizeDate(t)<=this.normalizeDate(e)}},Scule.interpreter.classes.QueryEngine=function(){this.comparator=new Scule.interpreter.classes.DateComparator,this.traverse=function(t,e){return Scule.global.functions.traverse(t,e)},this.traverseObject=function(t,e){return Scule.global.functions.traverseObject(Scule.global.functions.parseAttributes(t),e)},this.$ne=function(t,e){return!this.$eq(t,e)},this.$eq=function(t,e){return e instanceof RegExp?e.test(t):t instanceof Scule.db.classes.ObjectId?t.toString()==e:this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$eq(t,e):t==e},this.$gt=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$gt(t,e):t>e},this.$gte=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$gte(t,e):t>=e},this.$lt=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$lt(t,e):e>t},this.$lte=function(t,e){return this.comparator.isDate(t)&&this.comparator.isDate(e)?this.comparator.$lte(t,e):e>=t},this.$all=function(t,e){if(!Scule.global.functions.isArray(t)||!Scule.global.functions.isArray(e))return!1;var i=0,n={};for(i=0;i<t.length;i++)n[t[i]]=!0;for(i=0;i<e.length;i++)if(!n.hasOwnProperty(e[i]))return!1;return!0},this.$in=function(t,e){for(var i=0;i<e.length;i++)if(this.$eq(t,e[i]))return!0;return!1},this.$nin=function(t,e){for(var i=0;i<e.length;i++)if(this.$eq(t,e[i]))return!1;return!0},this.$elemMatch=function(t,e){if(!Scule.global.functions.isArray(t))return!1;for(var i=0;i<t.length;i++)if(e(t[i]))return!0;return!1},this.$size=function(t,e){return Scule.global.functions.isInteger(e)?Scule.global.functions.sizeOf(t)===e:!1},this.$exists=function(t,e){return e?void 0!==t:void 0===t},this.$within=function(t,e){if(!t.hasOwnProperty("lat")||!t.hasOwnProperty("lon"))return!1;if(!e.hasOwnProperty("lat")||!e.hasOwnProperty("lon"))return!1;var i=Math.sqrt(Math.pow(e.lat-t.lat,2)+Math.pow(e.lon-t.lon,2));return i<=e.distance},this.$near=function(t,e){if(!t.hasOwnProperty("lat")||!t.hasOwnProperty("lon"))return!1;if(!e.hasOwnProperty("lat")||!e.hasOwnProperty("lon"))return!1;var i=6371*Math.acos(Math.sin(t.lat)*Math.sin(e.lat)+Math.cos(t.lat)*Math.cos(e.lat)*Math.cos(e.lon-t.lon));return i<=e.distance},this.$sort=function(t,e,i){Scule.global.functions.sort(t,e,i)},this.$set=function(t,e,i){var n=t[0],s=t[1];n in s?s[n]=e:i===!0&&(s[n]=e)},this.$unset=function(t){var e=t[0],i=t[1];e in i&&delete i[e]},this.$inc=function(t,e,i){Scule.global.functions.isInteger(e)||(e=1);var n=t[0],s=t[1];n in s?(Scule.global.functions.isInteger(s[n])||Scule.global.functions.isDouble(s[n]))&&(s[n]+=e):i&&(s[n]=e)},this.$pull=function(t,e){var i=t[0],n=t[1];if(i in n&&Scule.global.functions.isArray(n[i])){for(var s=[],r=0;r<n[i].length;r++)n[i][r]!==e&&s.push(n[i][r]);n[i]=s}},this.$pullAll=function(t,e){var i=t[0],n=t[1];if(i in n&&Scule.global.functions.isArray(n[i])){if(!Scule.global.functions.isArray(e))throw"the $pullAll operator requires an associated array as an operand";var s=Scule.getHashTable();e.forEach(function(t){s.put(t,!0)});for(var r=0;r<n[i].length;r++)s.contains(n[i][r])&&(n[i].splice(r,1),r--)}},this.$pop=function(t){var e=t[0],i=t[1];e in i&&Scule.global.functions.isArray(i[e])&&i[e].pop()},this.$push=function(t,e,i){var n=t[0],s=t[1];n in s||!i?Scule.global.functions.isArray(s[n])&&s[n].push(e):s[n]=[e]},this.$pushAll=function(t,e,i){var n=t[0],s=t[1];if(n in s||!i){if(!Scule.global.functions.isArray(e))throw"the $pushAll operator requires an associated array as an operand";Scule.global.functions.isArray(s[n])&&e.forEach(function(t){s[n].push(t)})}else s[n]=e.slice(0)}},Scule.interpreter.classes.QueryCompiler=function(){this.cache=Scule.getHashTable(),this.engine=new Scule.interpreter.classes.QueryEngine,this.normalizer=new Scule.interpreter.classes.QueryNormalizer,this.compileConditions=function(t){var e,i,n="";return t.hasOwnProperty("$sort")&&(e=t.$sort,i=Scule.global.functions.objectKeys(e),1===i.length&&(n+="	engine.$sort("+e[i[0]]+', r, "'+i[0]+'");\n')),t.hasOwnProperty("$skip")&&(n+="	r.splice(0, "+t.$skip+");\n"),t.hasOwnProperty("$limit")&&(n+="	if (r.length > "+t.$limit+") {\n",n+="		r.splice("+t.$limit+");\n",n+="	}\n"),n},this.compileClauseList=function(t){var e=this,i=[];return Scule.global.functions.isArray(t)?(t.forEach(function(t){var n=[];for(var s in t)t.hasOwnProperty(s)&&(n=n.concat(e.compileQueryClauses(s,t[s])));i.push(n.join(" && "))}),i.join(" || ")):i},this.compileExpressions=function(t){t=this.normalizer.normalize(t);var e=[];for(var i in t)e=e.concat(this.compileQueryClauses(i,t[i]));return e},this.compileQueryClauses=function(t,e){var i=[];for(var n in e)if(this.engine.hasOwnProperty(n))if("$elemMatch"===n){var s=this.compileExpressions(e[n]),r="function(o) { return ("+s.join(" && ")+"); }";t.indexOf(".")<0?i.push("engine.$elemMatch(o."+t+", "+r+")"):i.push("engine.$elemMatch(engine.traverse("+JSON.stringify(t)+", o), "+r+")")}else{var a=null;a=e[n]instanceof RegExp?e[n].toString():e[n]instanceof Date?'new Date("'+e[n].toString()+'")':e[n]instanceof Scule.db.classes.ObjectDate?'new Date("'+e[n].toDate().toString()+'")':JSON.stringify(e[n]),t.indexOf(".")<0?i.push("engine."+n+"(o."+t+", "+a+")"):i.push("engine."+n+"(engine.traverse("+JSON.stringify(t)+", o), "+a+")")}return i},this.compileUpdateClauses=function(t,e,i){if(this.engine.hasOwnProperty(t)){var n=[];for(var s in e)n.push("		engine."+t+"(engine.traverseObject("+JSON.stringify(s)+", o), "+JSON.stringify(e[s])+", "+JSON.stringify(i)+");");return n}},this.compileUpdate=function(query,upsert,ignoreCache){var hash=Scule.md5.hash(this.serializeQuery(query));if(this.cache.contains(hash))return this.cache.get(hash);var updates=[],closure="var u = function(objects, collection, engine) {\n";closure+="	objects.forEach(function(o) {\n";for(var key in query)query.hasOwnProperty(key)&&(updates=updates.concat(this.compileUpdateClauses(key,query[key],upsert)));return closure+=updates.join("\n"),closure+="\n	});\n",closure+="	return objects;\n",closure+="}\n",ignoreCache?closure:(eval(closure),this.cache.put(hash,u),this.cache.get(hash))},this.serializeQuery=function(t){var e=Scule.global.functions.cloneObject(t),i=function(t){for(var e in t)t[e]instanceof Scule.db.classes.ObjectId||t[e]instanceof RegExp?t[e]=t[e].toString():Scule.global.functions.isScalar(t[e])||i(t[e])};return i(e),JSON.stringify(e)},this.compileQuery=function(query,conditions,ignoreCache){query=this.normalizer.normalize(query);var hash=Scule.md5.hash(this.serializeQuery(query)+this.serializeQuery(conditions));if(this.cache.contains(hash))return this.cache.get(hash);var closure="var c = function(objects, engine) {\n";if(closure+="	var r = [];\n",Scule.global.functions.sizeOf(query)>0){closure+="	objects.forEach(function(o) {\n",closure+="		o = o.element;\n";var ands=[],ors="";for(var key in query)query.hasOwnProperty(key)&&("$or"===key?ors="("+this.compileClauseList(query[key])+")":ands=ands.concat(this.compileQueryClauses(key,query[key])));ands.length>0?(ors.length>0&&(ors=" && "+ors),closure+="		if (("+ands.join(" && ")+")"+ors+") {\n",closure+="			r[r.length] = o;\n",closure+="		}\n"):ors.length>0&&(closure+="		if ("+ors+") {\n",closure+="			r[r.length] = o;\n",closure+="		}\n"),closure+="	});\n"}else closure+="	r = objects.toArray();\n";return conditions&&(closure+=this.compileConditions(conditions)),closure+="	return r;\n",closure+="};\n",ignoreCache?closure:(eval(closure),this.cache.put(hash,c),this.cache.get(hash))},this.explainQuery=function(t,e){var i=this.compileQuery(t,e,!0);return console.log(i),i},this.explainUpdate=function(t,e){var i=this.compileUpdate(t,e,!0);return console.log(i),i}},Scule.interpreter.classes.QueryInterpreter=function(){this.compiler=new Scule.interpreter.classes.QueryCompiler,this.interpret=function(t,e,i,n){if(n)return this.compiler.explainQuery(e,i);var s=t.documents.queue,r=this.compiler.compileQuery(e,i);return r(s,Scule.interpreter.objects.engine)},this.update=function(t,e,i,n,s,r){var a=this.interpret(t,e,n,r);if(r)return this.compiler.explainUpdate(i,s);var u=this.compiler.compileUpdate(i,s);return u(a,t,Scule.interpreter.objects.engine)}},Scule.interpreter.objects.engine=new Scule.interpreter.classes.QueryEngine,Scule.getQueryNormalizer=function(){return new Scule.interpreter.classes.QueryNormalizer},Scule.getQueryEngine=function(){return new Scule.interpreter.classes.QueryEngine},Scule.getQueryCompiler=function(){return new Scule.interpreter.classes.QueryCompiler},Scule.getQueryInterpreter=function(){return new Scule.interpreter.classes.QueryInterpreter},Scule.getDateComparator=function(){return new Scule.interpreter.classes.DateComparator}}(),function(){Scule.db.classes.SimpleCryptographyProvider=function(){this.signString=function(t,e,i){return Scule.sha1.hash(Scule.sha1.hash(t+e)+i)},this.signObject=function(t,e,i){return t._sig=i,this.signString(JSON.stringify(t),e,i)},this.signJSONString=function(t,e,i){return this.signString(JSON.stringify(t),e,i)},this.verifyObjectSignature=function(t,e,i){var n=t._sig,s=this.signObject(t,e,i);return n===s}},Scule.db.classes.StorageEngine=function(t){this.configuration=t,this.crypto=null,this.setConfiguration=function(t){this.configuration=t},this.getConfiguration=function(){return this.configuration},this.setCryptographyProvider=function(t){this.crypto=t},this.getCryptographyProvider=function(){return this.crypto}},Scule.db.classes.DummyStorageEngine=function(t){Scule.db.classes.StorageEngine.call(this,t),this.write=function(t,e,i){i&&i(e)},this.read=function(t,e){e&&e()}},Scule.db.classes.MemoryStorageEngine=function(t){Scule.db.classes.StorageEngine.call(this,t),this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider),this.storage={},this.write=function(t,e,i){e._salt||(e._salt=Scule.sha1.hash((new Date).getTime()+"")),e._sig=this.crypto.signObject(e,this.configuration.secret,e._salt),this.storage["__scule_collection__"+t]=JSON.stringify(e),i&&i(e)},this.read=function(t,e){if(!("__scule_collection__"+t in this.storage)){var i={_sig:null,_salt:Scule.sha1.hash((new Date).getTime()+""),_version:3,_name:t,_objects:{}};i._sig=this.crypto.signObject(i,this.configuration.secret,i._salt),this.storage["__scule_collection__"+t]=JSON.stringify(i)}var n=this.storage["__scule_collection__"+t],s=JSON.parse(n);if(this.crypto.verifyObjectSignature(s,this.configuration.secret,s._salt)===!1)throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection});delete s._sig,e&&e(s)}},Scule.db.classes.LocalStorageStorageEngine=function(t){if(Scule.db.classes.StorageEngine.call(this,t),this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider),!window||!window.hasOwnProperty("localStorage")&&null!==window.localStorage)throw JSON.stringify({event:"SculeLocalStorageError",message:"Local storage is not available on this device"});this.write=function(t,e,i){e._salt||(e._salt=Scule.sha1.hash((new Date).getTime()+""));try{e._sig=this.crypto.signObject(e,this.configuration.secret,e._salt),localStorage.setItem("__scule_collection__"+t,JSON.stringify(e)),i&&i(e)}catch(n){throw JSON.stringify({event:"SculeLocalStorageError",message:"Storage quota exceeded for origin",collection:this.configuration.collection})}},this.read=function(t,e){var i=localStorage.getItem("__scule_collection__"+t),n={};if(i){if(n=JSON.parse(i),this.crypto.verifyObjectSignature(n,this.configuration.secret,n._salt)===!1)throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection});delete n._sig}else n={_sig:null,_salt:Scule.sha1.hash((new Date).getTime()+""),_version:3,_name:t,_objects:{}};e&&e(n)}},Scule.db.classes.TitaniumDiskStorageEngine=function(t){Scule.db.classes.StorageEngine.call(this,t),this.configuration.path||(this.configuration.path=Titanium.Filesystem.applicationDataDirectory),this.setConfiguration=function(t){this.configuration=t,this.configuration.path||(this.configuration.path=Titanium.Filesystem.applicationDataDirectory)},this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider),this.write=function(t,e,i){e._salt||(e._salt=Scule.sha1.hash((new Date).getTime()+"")),e._sig=this.crypto.signObject(e,this.configuration.secret,e._salt);var n=Titanium.Filesystem.getFile(this.configuration.path,t+".json");return n.write(JSON.stringify(e)),i&&i(e),!0},this.read=function(t,e){var i=Titanium.Filesystem.getFile(this.configuration.path,t+".json");if(i.exists()){var n=JSON.parse(i.read());return this.crypto.verifyObjectSignature(n,this.configuration.secret,n._salt)===!1?(Ti.App.fireEvent("SculeDataTampered",{filename:t}),!1):(delete n._sig,e&&e(n),n)}return!1}},Scule.db.classes.NodeJSDiskStorageEngine=function(t){Scule.db.classes.StorageEngine.call(this,t),this.filesystem=require("fs"),this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider),this.write=function(t,e,i){var n=this.configuration.path+"/"+t+".json";e._salt||(e._salt=Scule.sha1.hash((new Date).getTime()+"")),e._sig=this.crypto.signObject(e,this.configuration.secret,e._salt),this.filesystem.writeFile(n,JSON.stringify(e),function(t){if(t)throw t;i&&i(e)})},this.read=function(t,e){var i=this.configuration.path+"/"+t+".json",n=this;this.filesystem.exists(i,function(s){return s?(n.filesystem.readFile(i,function(i,s){if(i)throw i;var r=JSON.parse(s);if(r._version>2&&n.crypto.verifyObjectSignature(r,n.configuration.secret,r._salt)===!1)throw JSON.stringify({event:"SculeDataTampered",filename:t});delete r._sig,e&&e(r)}),void 0):e({})})}},Scule.db.classes.ObjectId=function(t){if(void 0===t){for(var e=Math.floor((new Date).getTime()/1e3).toString(16),i=Scule.md5.hash(Scule.global.functions.getMACAddress()).substring(0,6),n=Scule.global.functions.randomFromTo(1e3,9999).toString(16);n.length<4;)n="0"+n;for(var s=Scule.global.functions.randomFromTo(1e5,999999).toString(16);s.length<6;)s="0"+s;t=e+i+n+s}this.id=t,this.$type="id",this.toString=function(){return this.id.toString()}},Scule.db.classes.ObjectDate=function(t,e){if(void 0===t&&void 0===e){var i=(new Date).getTime().toString();t=parseInt(i.substring(0,10),10),e=parseInt(i.substring(10),10)}this.ts=parseInt(t+e,10),this.sec=t,this.usec=e,this.$type="date",this.getTimestamp=function(){return this.ts},this.getSeconds=function(){return this.sec},this.getMicroSeconds=function(){return this.usec},this.toDate=function(){return new Date(1e3*this.sec+this.usec)}},Scule.db.classes.DBRef=function(t,e){if(void 0===t||void 0===e)throw"illegal object reference";this.ref=t,this.id=new Scule.db.classes.ObjectId(e),this.$type="dbref",this.getRef=function(){return this.ref},this.getId=function(){return this.id},this.resolve=function(){return this.resolveReference()},this.resolveReference=function(){var t=Scule.factoryCollection(this.ref);return t.findOne(this.id)}},Scule.db.classes.PrimaryKeyIndex=function(){this.table=Scule.getHashTable(),this.queue=Scule.getDoublyLinkedList(),this.clear=function(){this.table.clear(),this.queue.clear()},this.contains=function(t){return this.table.contains(t)},this.get=function(t){return this.table.contains(t)?this.table.get(t).element:null},this.add=function(t){var e=Scule.global.functions.getObjectId(t,!0);return this.table.contains(e)&&this.remove(t),this.table.put(e,this.queue.add(t)),!0},this.remove=function(t){var e=Scule.global.functions.getObjectId(t,!0);if(!this.table.contains(e))return!1;var i=this.table.remove(e);if(!i)return!1;var n=i.prev,s=i.next;return n&&(n.next=s),s&&(s.prev=n),i.detach(),i===this.queue.head?this.queue.head=s:i===this.queue.tail&&(this.queue.tail=n),this.queue.head===this.queue.tail&&(this.queue.tail=null),this.queue.length--,i.element},this.length=function(){return this.queue.length},this.toTable=function(){var t={};return this.queue.forEach(function(e){t[Scule.global.functions.getObjectId(e.element,!0)]=e.element}),t},this.toArray=function(){return this.queue.toArray()},this.toString=function(){var t="(h) ";return this.queue.forEach(function(e){t+=JSON.stringify(e.element)+" -> "}),t+="(t)"}},Scule.db.classes.Collection=function(t){this.documents=Scule.getPrimaryKeyIndex(),this.interpreter=Scule.getQueryInterpreter(),this.version=3,this.lastId=null,this.name=t,this.autoCommit=!1,this.isOpen=!1,this.storage=null,this.setStorageEngine=function(t){this.storage=t},this.setAutoCommit=function(t){this.autoCommit=t},this.getName=function(){return this.name},this.getLength=function(){return this.documents.length()},this.getLastInsertId=function(){return this.lastId},this.open=function(t){if(!this.isOpen){var e=this;this.storage.read(this.name,function(i){if(i){for(var n in i._objects)if(i._objects.hasOwnProperty(n)){var s=i._objects[n];Scule.db.functions.unflattenObject(i._objects[n]),e.documents.add(s)}e.isOpen=!0,t&&t(this)}})}},this.commit=function(t){var e={_sig:null,_salt:null,_name:this.name,_version:this.version,_objects:this.documents.toTable()};this.storage.write(this.name,e,t)},this.find=function(t,e,i){if(Scule.global.constants.ID_FIELD in t)return[this.findOne(t[Scule.global.constants.ID_FIELD])];var n=this.interpreter.interpret(this,t,e);return i&&i(n),n},this.explain=function(t,e,i){this.interpreter.interpret(this,t,e,!0),i&&i()},this.clear=function(t){this.documents.clear(),t&&t(this)},this.findAll=function(t){var e=this.documents.toArray();return t&&t(e),e},this.findOne=function(t,e){Scule.global.functions.isScalar(t)||(t=t.toString());var i=null;return this.documents.contains(t)&&(i=this.documents.get(t)),e&&e(i),i},this.save=function(t,e){return Scule.db.functions.unflattenObject(t),t.hasOwnProperty("_id")&&(t._id instanceof Scule.db.classes.ObjectId||(t._id=new Scule.db.classes.ObjectId(t._id))),this.documents.add(t),this.autoCommit&&this.commit(),this.lastId=Scule.global.functions.getObjectId(t),e&&e(this.lastId),this.lastId},this.update=function(t,e,i,n,s){var r=this.interpreter.update(this,t,e,i,n);return s&&s(r),r},this.count=function(t,e,i){var n=this.find(t,e).length;return i&&i(n),n},this.remove=function(t,e,i){var n=this,s=this.find(t,e);return s.forEach(function(t){n.documents.remove(t)}),i&&i(s),s},this.distinct=function(t,e,i){var n=this.find(e),s={};return n.forEach(function(e){e[t]in s||(s[e[t]]=0),s[e[t]]++}),i&&i(s),s},this.merge=function(t,e){if(!t)throw"the merge function requires a valid collection as a parameter";var i=this,n=t.findAll();return n.forEach(function(t){i.documents.contains(t._id)||i.documents.add(t)}),e&&e(this),!0},this.mapReduce=function(t,e,i,n){new Scule.db.classes.MapReduceHandler(t,e,i).run(this,n)}},Scule.db.classes.MapReduceHandler=function(t,e,i){if(this.options=i,!t)throw"A valid function is requires as the `map` parameter of the map/reduce operation";if(!e)throw"A valid function is requires as the `reduce` parameter of the map/reduce operation";if(!("out"in i))throw"A valid output collection connection url is required as the `out` parameter of the map/reduce options object";if(!("merge"in i.out||"reduce"in i.out))throw"A valid output collection connection url is required as either the `merge` or `reduce` out parameter of the map/reduce options object";"query"in i||(i.query={}),"conditions"in i||(i.conditions={}),this.map=t,this.reduce=e,this.finalize="finalize"in i?i.finalize:null,this.run=function(t,e){var i=this,n="merge"in this.options.out,s=Scule.factoryCollection(n?this.options.out.merge:this.options.out.reduce),r=Scule.getHashTable(),a=function(t,e){r.contains(t)||r.put(t,[]),r.get(t).push(e)},u=t.find(this.options.query,this.options.conditions);u.forEach(function(t){i.map(t,a)});var c=null;n&&(c=Scule.factoryCollection("scule+dummy://__mr"+(new Date).getTime()));var o=Scule.getHashTable(),l=r.getKeys();return l.forEach(function(t){o.put(t,i.reduce(t,r.get(t))),i.finalize&&o.put(t,i.finalize(t,o.get(t))),n?c.save(o.get(t)):s.save(o.get(t))}),n&&s.merge(c),e&&e(s),!0}},Scule.db.classes.CollectionFactory=function(){this.collections=Scule.getHashTable(),this.getCollection=function(t,e){if(this.collections.contains(t))return this.collections.get(t).c;e||(e={secret:"dummy"});var i=Scule.db.functions.parseCollectionURL(t);if(!(i.plugin in Scule.db.plugins))throw i.plugin+" is not a registered Scule plugin";if(!(i.engine in Scule.db.engines))throw i.engine+" is nto a registered Scule storage engine";var n=new Scule.db.engines[i.engine](e),s=new Scule.db.plugins[i.plugin](i.name);return s.setStorageEngine(n),s.open(),this.collections.put(t,{c:s,t:(new Date).getTime()}),this.collections.get(t).c}},Scule.db.functions.debug=function(t){Scule.db.global.debug===!0&&console.log(t)},Scule.db.functions.unflattenObject=function(t){var e=function(t){if(!Scule.global.functions.isScalar(t))for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];if(!Scule.global.functions.isScalar(n)&&n&&"$type"in n)switch(n.$type){case"date":t[i]=new Scule.db.classes.ObjectDate(n.sec,n.usec),t[i].ts=n.ts;break;case"id":t[i]=new Scule.db.classes.ObjectId(n.id);break;case"dbref":t[i]=new Scule.db.classes.DBRef(n.ref,n.id)}else e(n)}};e(t),Scule.global.constants.ID_FIELD in t||(t[Scule.global.constants.ID_FIELD]=new Scule.db.classes.ObjectId)},Scule.db.functions.parseCollectionURL=function(t){var e=t.match(/^([^\+]*)\+([^\/]*)\:\/\/(.*)/);if(!e||4!==e.length)throw t+" is an invalid collection url";return{plugin:e[1],engine:e[2],name:e[3]}},Scule.db.objects.core.collections.factory=new Scule.db.classes.CollectionFactory,Scule.debug=function(t){Scule.global.variables.debug=t},Scule.registerStorageEngine=function(t,e){if(t in Scule.db.engines)throw t+" storage engine is already registered";Scule.db.engines[t]=e},Scule.registerCollectionPlugin=function(t,e){if(t in Scule.db.plugins)throw t+" collection plugin is already registered";Scule.db.plugins[t]=e},function(){Scule.registerStorageEngine("memory",Scule.db.classes.MemoryStorageEngine),Scule.registerStorageEngine("dummy",Scule.db.classes.DummyStorageEngine),Scule.registerStorageEngine("local",Scule.db.classes.LocalStorageStorageEngine),Scule.registerStorageEngine("nodejs",Scule.db.classes.NodeJSDiskStorageEngine),Scule.registerStorageEngine("titanium",Scule.db.classes.TitaniumDiskStorageEngine),Scule.registerCollectionPlugin("scule",Scule.db.classes.Collection)}(),Scule.factoryCollection=function(t,e){return Scule.db.objects.core.collections.factory.getCollection(t,e)},Scule.dropAll=function(){Scule.db.objects.core.collections.factory.collections.clear()},Scule.getIndex=function(){return new Scule.db.classes.Index},Scule.getHashTableIndex=function(t){return new Scule.db.classes.HashTableIndex(t)},Scule.getObjectId=function(t){return new Scule.db.classes.ObjectId(t)},Scule.getObjectDate=function(t,e){return new Scule.db.classes.ObjectDate(t,e)},Scule.getObjectDateFromDate=function(t){if(!(t instanceof Date))throw new Error("unable to factory ObjectDate from non-date object");var e=t.getTime().toString(),i=parseInt(e.substring(0,10),10),n=parseInt(e.substring(10),10);return new Scule.db.classes.ObjectDate(i,n)},Scule.getDBRef=function(t,e){return new Scule.db.classes.DBRef(t,e)},Scule.getMemoryStorageEngine=function(t){return new Scule.db.classes.MemoryStorageEngine(t)},Scule.getLocalStorageStorageEngine=function(t){return new Scule.db.classes.LocalStorageStorageEngine(t)},Scule.getNodeJSDiskStorageEngine=function(t){return new Scule.db.classes.NodeJSDiskStorageEngine(t)},Scule.getTitaniumDiskStorageEngine=function(t){return new Scule.db.classes.TitaniumDiskStorageEngine(t)},Scule.getSimpleCryptographyProvider=function(){return new Scule.db.classes.SimpleCryptographyProvider}}(),function(){"undefined"!=typeof Titanium&&"undefined"!=typeof Titanium.Platform?(Scule.md5={hash:function(t){return Ti.Utils.md5HexDigest(t)}},Scule.sha1={hash:function(t){return Ti.Utils.sha1(t)}},module.exports=Scule):"undefined"!=typeof exports&&this.exports!==exports?(Scule.md5={m:require("crypto"),hash:function(t){return this.m.createHash("md5").update(t).digest("hex")}},Scule.sha1={m:require("crypto"),hash:function(t){return this.m.createHash("sha1").update(t).digest("hex")}},module.exports=Scule):Scule.global.system.installHashFunctions()}();